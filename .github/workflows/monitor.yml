name: Guardian - Monitor The Foundry

on:
  schedule:
    - cron: '*/15 * * * *'  # Check every 15 minutes
  workflow_dispatch:  # Allow manual trigger

jobs:
  monitor-and-restore:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout guardian repository
        uses: actions/checkout@v4
        with:
          path: guardian
      
      - name: Checkout the-foundry repository
        uses: actions/checkout@v4
        with:
          repository: nickarrow/the-foundry
          token: ${{ secrets.FOUNDRY_GUARDIAN_TOKEN }}
          path: the-foundry
          fetch-depth: 0  # Full history for finding last good state
      
      - name: Check workflow integrity
        id: check
        run: |
          cd the-foundry
          
          echo "ðŸ” Checking workflow integrity..."
          
          TAMPERED=false
          
          # Files to protect
          PROTECTED_FILES=(
            ".github/workflows/enforce-ownership.yml"
            ".github/scripts/enforce_ownership.py"
          )
          
          for file in "${PROTECTED_FILES[@]}"; do
            echo "Checking: $file"
            
            # Check if file exists
            if [ ! -f "$file" ]; then
              echo "âŒ MISSING: $file"
              TAMPERED=true
            else
              # Compare with canonical version from guardian repo
              CANONICAL_FILE="../guardian/canonical-workflows/$(basename $file)"
              if [ -f "$CANONICAL_FILE" ]; then
                if ! diff -q "$file" "$CANONICAL_FILE" > /dev/null 2>&1; then
                  echo "âŒ MODIFIED: $file"
                  TAMPERED=true
                else
                  echo "âœ… OK: $file"
                fi
              fi
            fi
          done
          
          if [ "$TAMPERED" = true ]; then
            echo "TAMPERED=true" >> $GITHUB_ENV
            echo "NEEDS_RESTORE=true" >> $GITHUB_ENV
          else
            echo "âœ… All workflow files are intact"
          fi
      
      - name: Find last known good state
        if: env.TAMPERED == 'true'
        run: |
          cd the-foundry
          
          echo "ðŸ” Finding last known good state..."
          
          LAST_GOOD_COMMIT=""
          COMMITS_CHECKED=0
          
          PROTECTED_FILES=(
            ".github/workflows/enforce-ownership.yml"
            ".github/scripts/enforce_ownership.py"
          )
          
          # Search through commits to find last good state
          for commit in $(git log --format=%H -100); do
            COMMITS_CHECKED=$((COMMITS_CHECKED + 1))
            WORKFLOW_OK=true
            
            for file in "${PROTECTED_FILES[@]}"; do
              # Check if file exists in this commit
              if ! git show $commit:"$file" > /tmp/check_version 2>/dev/null; then
                WORKFLOW_OK=false
                break
              fi
              
              # Compare with canonical version
              CANONICAL_FILE="../guardian/canonical-workflows/$(basename $file)"
              if [ -f "$CANONICAL_FILE" ]; then
                if ! diff -q /tmp/check_version "$CANONICAL_FILE" > /dev/null 2>&1; then
                  WORKFLOW_OK=false
                  break
                fi
              fi
            done
            
            if [ "$WORKFLOW_OK" = true ]; then
              LAST_GOOD_COMMIT=$commit
              COMMIT_DATE=$(git show -s --format=%ci $commit)
              echo "âœ… Found last known good state: $commit"
              echo "   Date: $COMMIT_DATE"
              echo "   Commits checked: $COMMITS_CHECKED"
              echo "LAST_GOOD_COMMIT=$commit" >> $GITHUB_ENV
              break
            fi
          done
          
          if [ -z "$LAST_GOOD_COMMIT" ]; then
            echo "âš ï¸ Could not find good state in last 100 commits"
            echo "LAST_GOOD_COMMIT=HEAD^" >> $GITHUB_ENV
          fi
      
      - name: Restore repository to last good state
        if: env.NEEDS_RESTORE == 'true'
        run: |
          cd the-foundry
          
          echo "ðŸ”„ Restoring repository to last known good state..."
          
          CURRENT_COMMIT=$(git rev-parse HEAD)
          LAST_GOOD=${{ env.LAST_GOOD_COMMIT }}
          
          # Restore workflow files from guardian repo
          echo "Restoring workflow files from canonical versions..."
          cp ../guardian/canonical-workflows/enforce-ownership.yml .github/workflows/
          cp ../guardian/canonical-workflows/enforce_ownership.py .github/scripts/
          
          # Restore all other content from last good commit
          echo "Restoring content files from last good state..."
          git diff --name-status $LAST_GOOD $CURRENT_COMMIT | while IFS=$'\t' read -r status file; do
            # Skip .github/ files as we already restored them from canonical versions
            if [[ "$file" == .github/* ]]; then
              echo "  Skipping .github file (already restored): $file"
              continue
            fi
            
            case $status in
              D)
                echo "  Restoring deleted: $file"
                git checkout $LAST_GOOD -- "$file" 2>/dev/null || true
                ;;
              M)
                echo "  Restoring modified: $file"
                git checkout $LAST_GOOD -- "$file" 2>/dev/null || true
                ;;
              A)
                echo "  Removing unauthorized addition: $file"
                rm -f "$file" 2>/dev/null || true
                ;;
              R*)
                # For renames, git diff shows: R<score>\told_name\tnew_name
                oldfile=$(echo "$file" | cut -f1)
                newfile=$(echo "$file" | cut -f2)
                echo "  Reverting rename: $newfile -> $oldfile"
                rm -f "$newfile" 2>/dev/null || true
                git checkout $LAST_GOOD -- "$oldfile" 2>/dev/null || true
                ;;
            esac
          done
          
          echo "CURRENT_COMMIT=$CURRENT_COMMIT" >> $GITHUB_ENV
      
      - name: Commit and push restoration
        if: env.NEEDS_RESTORE == 'true'
        run: |
          cd the-foundry
          
          git config user.name "Guardian Bot"
          git config user.email "guardian@the-foundry.bot"
          git add -A
          git commit -m "Guardian: Restored files after unauthorized changes detected" \
                     -m "Detected compromise of workflow files." \
                     -m "All affected files have been restored." \
                     -m "Last known good state: ${{ env.LAST_GOOD_COMMIT }}" \
                     -m "Compromised state: ${{ env.CURRENT_COMMIT }}" \
                     -m "This restoration was performed by the external Guardian monitoring system."
          git push origin main
          
          echo "âœ… Repository restored and pushed"
      
      - name: Collect attack details
        if: env.NEEDS_RESTORE == 'true'
        id: attack_details
        run: |
          cd the-foundry
          
          LAST_GOOD=${{ env.LAST_GOOD_COMMIT }}
          CURRENT=${{ env.CURRENT_COMMIT }}
          
          echo "========================================"
          echo "GUARDIAN ATTACK DETECTED"
          echo "========================================"
          echo ""
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Last Known Good Commit: $LAST_GOOD"
          echo "Compromised Commit: $CURRENT"
          echo ""
          echo "ATTACKERS:"
          ATTACKERS=$(git log $LAST_GOOD..$CURRENT --format="%an <%ae>" | sort -u)
          echo "$ATTACKERS"
          echo ""
          echo "MALICIOUS COMMITS:"
          COMMITS=$(git log $LAST_GOOD..$CURRENT --oneline)
          echo "$COMMITS"
          echo ""
          echo "FILES AFFECTED:"
          FILES=$(git diff --name-status $LAST_GOOD $CURRENT | head -20)
          echo "$FILES"
          echo ""
          echo "âœ… Repository has been restored"
          echo "âœ… Check this workflow log for attack details"
          echo "========================================"
          
          # Save details for issue creation
          echo "ATTACKERS<<EOF" >> $GITHUB_ENV
          echo "$ATTACKERS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "COMMITS<<EOF" >> $GITHUB_ENV
          echo "$COMMITS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "FILES<<EOF" >> $GITHUB_ENV
          echo "$FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_ENV
      
      - name: Create GitHub Issue alert
        if: env.NEEDS_RESTORE == 'true'
        run: |
          cd the-foundry
          
          # Create issue body
          cat > /tmp/issue_body.md << 'ISSUE_EOF'
          # ðŸš¨ Guardian Alert: Unauthorized Changes Detected and Restored
          
          The Guardian monitoring system detected and automatically restored unauthorized changes to The Foundry repository.
          
          ## Attack Details
          
          **Timestamp:** ${{ env.TIMESTAMP }}
          
          **Last Known Good Commit:** `${{ env.LAST_GOOD_COMMIT }}`
          
          **Compromised Commit:** `${{ env.CURRENT_COMMIT }}`
          
          ## Attackers
          
          ```
          ${{ env.ATTACKERS }}
          ```
          
          ## Malicious Commits
          
          ```
          ${{ env.COMMITS }}
          ```
          
          ## Files Affected
          
          ```
          ${{ env.FILES }}
          ```
          
          ## Actions Taken
          
          âœ… Repository has been automatically restored to last known good state
          âœ… Workflow protection files restored from canonical versions
          âœ… All unauthorized changes have been reverted
          
          ## Investigation
          
          Review the [Guardian workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for complete details.
          
          ---
          
          *This issue was automatically created by the Guardian monitoring system.*
          ISSUE_EOF
          
          # Create the issue using GitHub CLI
          gh issue create \
            --title "ðŸš¨ Guardian Alert: Unauthorized changes detected at ${{ env.TIMESTAMP }}" \
            --body-file /tmp/issue_body.md \
            --label "security,guardian-alert" \
            --repo nickarrow/the-foundry
        env:
          GH_TOKEN: ${{ secrets.FOUNDRY_GUARDIAN_TOKEN }}
